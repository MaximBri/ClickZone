# Глобальная установка Backend-зависимостей

Чтобы подготовить среду для работы с серверной частью, выполните следующие шаги:

## 1. Установка Python

Перейдите на [официальный сайт Python.org](https://www.python.org/) и скачайте рекомендованную стабильную версию языка программирования `Python` 3.x для вашей ОС.

Запустите установщик:

* **Windows**: выберите опцию “Add Python to PATH” перед установкой.
* **macOS/Linux**: по умолчанию путь добавляется автоматически.

Проверьте установку в терминале:

```bash
python --version
```

или

```bash
python3 --version
```

## 2. Установка Poetry

`Poetry` — это современный инструмент управления зависимостями и виртуальными окружениями.

### 2.1. Быстрая установка

Выполните команду в терминале (работает на UNIX-подобных и Windows PowerShell):

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Или (PowerShell):

```powershell
(Invoke-WebRequest https://install.python-poetry.org -UseBasicParsing).Content | python -
```

### 2.2. Проверка установки

После завершения установки перезапустите терминал и выполните:

```bash
poetry --version
```

## 3. Установка зависимостей проекта

1. Перейдите в папку сервера:

   ```bash
   cd backend
   ```

2. Установите все зависимости из `pyproject.toml` и создайте виртуальное окружение:

   ```bash
   poetry install
   ```

3. После завершения установки внутри `.venv` будет создана виртуальная среда со всеми пакетами. Чтобы активировать её, выполните:

   ```bash
   poetry shell
   ```

# Документация по проекту:

Технологии: Flask, Flask-SQLAlchemy, Flask-Migrate, Flask-CORS, Flask-JWT-Extended, Pydantic, python-dotenv, PostgreSQL

## 1. Entry-point и конфигурация

- **ClickZone.py**  
  — Главный скрипт запуска приложения. Создаёт shell context с сущностями базы данных и вызывает функцию create_app (паттерн Factory), которая создаёт Flask-экземпляр, регистрирует блюпринты, подключает CORS, JWT, redis, миграции и настройки из `config.py`.

- **config.py**  
  — чтение переменных окружения (`.env`), базовые настройки Flask (DB URI, JWT-секрет, CORS-параметры).

- **boot.sh**  
  — скрипт для разовой инициализации (запуск миграций и сервера gunicorn, который выполняет код Flask в отдельных 4 процессах).

- **Dockerfile**, **docker-compose.yml**  
  — контейнеризация приложения и БД.

## 2. Миграции и база данных

- **migrations/**  
  — директория Alembic:  
  - `env.py`, `alembic.ini`, скрипты версий в `versions/`.  
  - Хранят историю изменений схемы БД.
    
## 3. Файлы конфигурации проекта

- **pyproject.toml**, **poetry.lock**  
  — управляют зависимостями и скриптами запуска.

- **.env.example**  
  — пример необходимых переменных окружения.

## 4. Слой веб приложения

### 4.1 Слой инициализации веб приложения 

   - **app/__init__.py**  
     — Инициализация logging, CORS, JWTManager, SQLAlchemy, Migrate, Redis.
     - Функция create_app:
     1. которая инициализирует Flask instance и инициирует Flask instance у ранее созданных CORS, SQLAlchemy, Migrate, JWTManager.
     2. регистрирует все блюпринты - пути для эндпоинтов (обработчиков запросов).

### 4.1 Слой моделей базы данных приложения

   - **app/models.py**  
     — SQLAlchemy-модели: `User`, `Upgrade`, `UserUpgrade`, `Achievement`, `UserAchievement`, `Container`, `ContainerReward`, `UserContainer`, `DailyReward`.  
     - Описывают таблицы, связи, конструкторы.
 
### 4.2 Слой ошибок и обработчиков приложения

- **app/errors/custom_errors.py**  
  — класс исключений `InsufficientMoneyError`.

- **app/errors/handlers.py**  
  — функции-хэндлеры для `@app.errorhandler(...)` или `@app.route(...)`, возвращают JSON-ответ с кодом и сообщением.

### 4.3 Слой JWT приложения

- **app/jwt_handlers/handlers.py**  
  — колбеки Flask-JWT-Extended: `user_lookup_loader`, `token_in_blocklist_loader` и т. д.

### 4.4 Слой API (блюпринты)

Каждый раздел API вынесен в отдельный блюпринт:
```text
app/
├── auth/ # регистрация, логин, логаут
│ ├── routes.py
│ └── validators/ # Pydantic-схемы для входящих форм
│ ├── login_form.py
│ └── registration_form.py
│
├── profile/ # просмотр и редактирование профиля
│ ├── routes.py
│ └── validators/
│ └──- profile_form.py
│
├── containers/ # покупка и открытие контейнеров
│ ├── routes.py
│ └── validators/
│ └── container_open_form.py
│
├── upgrades/ # список и активация улучшений
│ ├── routes.py
│ └── validators/
│ └── upgrade_form.py
│
├── daily_rewards/ # получение ежедневных наград
│ └── routes.py
│
├── main/ # основной гейм-эндпойнт (клики, баланс)
│ ├── routes.py
│ ├── services/ # бизнес-логика (например, calculate_max_click)
│ │ └── click_service.py
│ └── validators/
│ └── click_form.py
```
**Validator-слои** (`Pydantic`):  
— в каждой папке `validators/` лежат схемы (`*.py`), которые проверяют и парсят JSON из запроса.

## 8. Сервисный слой

- **app/main/services/**  
  — функция, которая реализует бизнес-логику (расчёт кликов, начисление наград и т. д.).  
  — Используются внутри route-хэндлеров.
